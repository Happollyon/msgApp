<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>AuthContext.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-App.html">App</a><ul class='methods'><li data-type='method'><a href="module-App.html#~App">App</a></li><li data-type='method'><a href="module-App.html#~ChatRoute">ChatRoute</a></li><li data-type='method'><a href="module-App.html#~ContactsRoute">ContactsRoute</a></li><li data-type='method'><a href="module-App.html#~InsideApp">InsideApp</a></li><li data-type='method'><a href="module-App.html#~MainNavigation">MainNavigation</a></li><li data-type='method'><a href="module-App.html#~ProfileRoute">ProfileRoute</a></li><li data-type='method'><a href="module-App.html#~StackTest">StackTest</a></li><li data-type='method'><a href="module-App.html#~checkLoggedInStatus">checkLoggedInStatus</a></li></ul></li><li><a href="module-AuthContext.html">AuthContext</a><ul class='methods'><li data-type='method'><a href="module-AuthContext.html#~AuthProvider">AuthProvider</a></li><li data-type='method'><a href="module-AuthContext.html#~connectWebSocket">connectWebSocket</a></li><li data-type='method'><a href="module-AuthContext.html#~getChatsAndMessages">getChatsAndMessages</a></li><li data-type='method'><a href="module-AuthContext.html#~getuserData">getuserData</a></li></ul></li><li><a href="module-Calculator.html">Calculator</a><ul class='methods'><li data-type='method'><a href="module-Calculator.html#~handleCalculate">handleCalculate</a></li><li data-type='method'><a href="module-Calculator.html#~handleClear">handleClear</a></li><li data-type='method'><a href="module-Calculator.html#~handleDelete">handleDelete</a></li><li data-type='method'><a href="module-Calculator.html#~handlePress">handlePress</a></li></ul></li><li><a href="module-Camera.html">Camera</a><ul class='methods'><li data-type='method'><a href="module-Camera.html#~pickImage">pickImage</a></li><li data-type='method'><a href="module-Camera.html#~sendMessage">sendMessage</a></li><li data-type='method'><a href="module-Camera.html#~takePhoto">takePhoto</a></li><li data-type='method'><a href="module-Camera.html#~toggleCameraFacing">toggleCameraFacing</a></li><li data-type='method'><a href="module-Camera.html#~uploadImage">uploadImage</a></li></ul></li><li><a href="module-ChatComponent.html">ChatComponent</a><ul class='methods'><li data-type='method'><a href="module-ChatComponent.html#~blockUser">blockUser</a></li><li data-type='method'><a href="module-ChatComponent.html#~findChatByOtherUserId">findChatByOtherUserId</a></li><li data-type='method'><a href="module-ChatComponent.html#~sendMessage">sendMessage</a></li><li data-type='method'><a href="module-ChatComponent.html#~unblockUser">unblockUser</a></li></ul></li><li><a href="module-ChatItem.html">ChatItem</a><ul class='methods'><li data-type='method'><a href="module-ChatItem.html#~convertTimeStamp">convertTimeStamp</a></li><li data-type='method'><a href="module-ChatItem.html#~countUnreadMessages">countUnreadMessages</a></li><li data-type='method'><a href="module-ChatItem.html#~workWithMsg">workWithMsg</a></li></ul></li><li><a href="module-ChatScreen.html">ChatScreen</a><ul class='methods'><li data-type='method'><a href="module-ChatScreen.html#~getuserData">getuserData</a></li><li data-type='method'><a href="module-ChatScreen.html#~search">search</a></li></ul></li><li><a href="module-ChatStack.html">ChatStack</a></li><li><a href="module-ContactItem.html">ContactItem</a><ul class='methods'><li data-type='method'><a href="module-ContactItem.html#~addFriend">addFriend</a></li><li data-type='method'><a href="module-ContactItem.html#~removeFriend">removeFriend</a></li></ul></li><li><a href="module-ContactsScreen.html">ContactsScreen</a></li><li><a href="module-ContactsStack.html">ContactsStack</a></li><li><a href="module-MessageComponent.html">MessageComponent</a><ul class='methods'><li data-type='method'><a href="module-MessageComponent.html#~convertTimeStamp">convertTimeStamp</a></li></ul></li><li><a href="module-ProfileScreen.html">ProfileScreen</a></li><li><a href="module-UpdatePassword.html">UpdatePassword</a><ul class='methods'><li data-type='method'><a href="module-UpdatePassword.html#~UpdatePassword">UpdatePassword</a></li><li data-type='method'><a href="module-UpdatePassword.html#~passwordSanity">passwordSanity</a></li></ul></li><li><a href="module-screens_ModalComp.html">screens/ModalComp</a></li><li><a href="module-screens_beforeLogin_EmailVerification.html">screens/beforeLogin/EmailVerification</a><ul class='methods'><li data-type='method'><a href="module-screens_beforeLogin_EmailVerification.html#~enterCode">enterCode</a></li><li data-type='method'><a href="module-screens_beforeLogin_EmailVerification.html#~resendcode">resendcode</a></li><li data-type='method'><a href="module-screens_beforeLogin_EmailVerification.html#~verifyCode">verifyCode</a></li></ul></li><li><a href="module-screens_beforeLogin_Login.html">screens/beforeLogin/Login</a><ul class='methods'><li data-type='method'><a href="module-screens_beforeLogin_Login.html#~getContacts">getContacts</a></li><li data-type='method'><a href="module-screens_beforeLogin_Login.html#~login">login</a></li></ul></li><li><a href="module-screens_beforeLogin_LoginOrRegister.html">screens/beforeLogin/LoginOrRegister</a><ul class='methods'><li data-type='method'><a href="module-screens_beforeLogin_LoginOrRegister.html#~navigateToLogin">navigateToLogin</a></li><li data-type='method'><a href="module-screens_beforeLogin_LoginOrRegister.html#~navigateToRegister">navigateToRegister</a></li></ul></li><li><a href="module-screens_beforeLogin_Password.html">screens/beforeLogin/Password</a><ul class='methods'><li data-type='method'><a href="module-screens_beforeLogin_Password.html#~passwordSanity">passwordSanity</a></li><li data-type='method'><a href="module-screens_beforeLogin_Password.html#~setPassword">setPassword</a></li></ul></li><li><a href="module-screens_beforeLogin_Register.html">screens/beforeLogin/Register</a><ul class='methods'><li data-type='method'><a href="module-screens_beforeLogin_Register.html#~handleEmailChange">handleEmailChange</a></li><li data-type='method'><a href="module-screens_beforeLogin_Register.html#~handleNameChange">handleNameChange</a></li><li data-type='method'><a href="module-screens_beforeLogin_Register.html#~submitNameEmail">submitNameEmail</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">AuthContext.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// AuthContext.js
import React, { createContext, useState, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { get } from 'react-native/Libraries/TurboModule/TurboModuleRegistry';

/**
 * @module AuthContext
 * @description Provides authentication context and WebSocket connection management. 
 * @autho GitHub Copilot
 */

export const AuthContext = createContext();

const appConfig = require('./appConf.json');
const webSocketUrl = appConfig.webSocketUrl;

/**
 * @function AuthProvider
 * @description Provides authentication context to its children.
 * @param {Object} children - The child components that will consume the context.
 * @returns {JSX.Element} The AuthContext provider with its value.
 */
export const AuthProvider = ({ children }) => {
  const [loggedIn, setLoggedIn] = useState(false);
  const [userInfo, setUserInfo] = useState(null); // Holds user information
  const [contactList, setContactList] = useState([]); // Holds the contact list
  const [socket, setSocket] = useState(null);
  const [chats, setChats] = useState([]);
  const [messages, setMessages] = useState([]);

  useEffect(() => {
    if (loggedIn) {
      /**
       * @function getuserData
       * @description Fetches user data from the backend.
       * @throws Will throw an error if the network request fails.
       */
      const getuserData = async () => {
        const token = await AsyncStorage.getItem('token');
        try {
          const baseurlBack = appConfig.baseurlBack + "/user/getUser";

          const response = await fetch(baseurlBack, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.status === 200) {
            const responseData = await response.json();
            if (!responseData.error) {
              
              const userData = {
                id: responseData.data.id, // Assuming the ID is part of the response data
                name: responseData.data.name,
                email: responseData.data.email,
                avatarUrl: responseData.data.avatarUrl,
                status: responseData.data.status,
                messages: responseData.data.messages,
                description: responseData.data.description,
                vibration: responseData.data.vibration,
                sound: responseData.data.sound,
                notification: responseData.data.notification
              };

              setUserInfo(userData);
            } else {
              console.error("Error getting data:", responseData.error);
            }
          } else {
            console.error("Error getting data:", response.status);
          }
        } catch (e) {
          console.error("Network Error:", e);
        }
      };

      getuserData();
    }
  }, [loggedIn]);

  useEffect(() => {
    if (loggedIn &amp;&amp; userInfo &amp;&amp; userInfo.id) { // If the user is logged in and the user info is available
      let ws; // WebSocket instance

      /**
       * @function connectWebSocket
       * @description Establishes a WebSocket connection and handles events.
       */
      const connectWebSocket = () => {
        ws = new WebSocket(webSocketUrl); // Create a new WebSocket

        ws.onopen = () => { // When the WebSocket connection is opened
          ws.send(userInfo.id); // Send the user ID to the server
          setSocket(ws);
        };

        ws.onmessage = (event) => { // When a message is received from the server
          getChatsAndMessages();
        };

        ws.onclose = (event) => {
          setSocket(null);
          // Attempt to reconnect after 5 seconds if the close code is 1001
          if (event.code === 1001) {
            setTimeout(connectWebSocket, 5000);
          }
        };
      };

      connectWebSocket();

      return () => {
        if (ws) {
          ws.close();
        }
      };
    }
  }, [loggedIn, userInfo]);

  /**
   * @function getChatsAndMessages
   * @description Fetches chats and messages from the backend.
   * @throws Will throw an error if the network request fails.
   */
  const getChatsAndMessages = async () => {
    const token = await AsyncStorage.getItem('token');
    try {
      const baseurlBack = appConfig.baseurlBack + "/chats/getChatsAndMessages";
      
      const response = await fetch(baseurlBack, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      if (response.status === 200) {
        const responseData = await response.json();
        if (!responseData.error) {
          setChats(responseData.chats);
        } else {
          console.error("Error getting chats and messages:", responseData.error);
        }
      } else {
        console.error("Error getting chats and messages:", response.status);
      }
    } catch (e) {
      console.error("Network Error:", e);
    }
  };

  useEffect(() => {
    if (loggedIn &amp;&amp; userInfo &amp;&amp; userInfo.id) {
      getChatsAndMessages();
    }
  }, [loggedIn, userInfo]);

  return (
    &lt;AuthContext.Provider value={{ loggedIn, setLoggedIn, userInfo, setUserInfo, contactList, setContactList, socket, messages, setMessages, setChats, chats }}>
      {children}
    &lt;/AuthContext.Provider>
  );
};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Wed Aug 07 2024 16:19:44 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
